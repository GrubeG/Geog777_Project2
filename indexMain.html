<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>
      Sequoia and Kings Canyon Tree Locator
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.23/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.23/"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #info {
        padding: 14px;
        border-radius: 5px;
        width: 35%;
      }
        
      #infoToolbar {
        padding: 14px;
        border-radius: 5px;
        width: 35%;
      }
        
      #queryDiv {
        padding: 14px;
        border-radius: 5px;
        width: 35%;
      }
        
     #pois-filter {
        height: 160px;
        width: 100%;
        visibility: hidden;
      }

      .poi-item {
        width: 100%;
        padding: 12px;
        text-align: center;
        vertical-align: baseline;
        cursor: pointer;
        height: 40px;
      }

      .poi-item:focus {
        background-color: dimgrey;
      }

      .poi-item:hover {
        background-color: dimgrey;
      }
        
        
    </style>
    <script>
      require([
        "esri/Map",
        "esri/layers/FeatureLayer",
        "esri/widgets/Editor",
        "esri/widgets/LayerList",
        "esri/views/MapView",
        "esri/popup/content/AttachmentsContent",
        "esri/popup/content/TextContent",
        "esri/widgets/Expand",
        "esri/widgets/Home",
        "esri/widgets/Search",
        "esri/Viewpoint",
        "esri/widgets/Locate",
        "esri/layers/GraphicsLayer",
        "esri/geometry/geometryEngine",
        "esri/Graphic",
        "esri/symbols/SimpleFillSymbol",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/config",
          
        "dojo/on",
        "dojo/dom",
        "dojo/dom-construct",
        "dojo/domReady!"
      ], (
        Map,
        FeatureLayer,
        Editor,
        LayerList,
        MapView,
        AttachmentsContent,
        TextContent,
        Expand,
        Home,
        Search,
        Viewpoint,
        Locate,
        GraphicsLayer,
        geometryEngine,
        Graphic,
        SimpleFillSymbol,
        SimpleMarkerSymbol,
        esriConfig,
        on, dom, domConstruct
      ) => {
          
        esriConfig.apiKey = "AAPKd7a5f0028e3d432faec9c8e03740f0d8ntcrv-SGuCaGKZrLrQxv4azO6TaiERQO5QwoBDUznyrB6hxLK2EZe7oCwvq7bldk";
          
        // add the park outline featurelayer
        var layerBoundary = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_boundary/FeatureServer/0",
          //outFields: ["*"],
          opacity: 0.3,
          title: "Park Boundaries",
          visible: true
        });
          
        // add the park groves featurelayer
        var layerGroves = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/CA_SEGI_groves/FeatureServer/0",
          //outFields: ["*"],
          opacity: 0.5,
          title: "Sequoia Groves",
          visible: true,
          popupTemplate: {
            // autocasts as new PopupTemplate()
            title: "{Grove_Name}",
            overwriteActions: true
          }
        });
        
        // add the park roads featurelayer
        var layerRoads = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_roads/FeatureServer/0",
          //outFields: ["*"],
          opacity: 0.8,
          title: "Park Roads",
          visible: true,
          popupTemplate: {
            // autocasts as new PopupTemplate()
            title: "{RDNAME}: </br>{RDCLASS}",
            overwriteActions: true
          }
        });
        
        // add the park trails featurelayer
        var layerTrails = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_trails/FeatureServer/0",
          //outFields: ["*"],
          opacity: 0.8,
          title: "Park Trails",
          visible: true,
          popupTemplate: {
            // autocasts as new PopupTemplate()
            title: "{TRLNAME}: </br>{TRLCLASS}",
            overwriteActions: true
          }
        });
          
        // View how each marker
        // symbol is created for Points of Interest
        const layerPOIRenderer = {
          type: "unique-value",
          field: "POITYPE",
          uniqueValueInfos: [
            {
              value: "Restroom",
              symbol: {
                type: "picture-marker",
                url: "https://developers.arcgis.com/javascript/latest/sample-code/visualization-point-styles/live/Museum.png",
                contentType: "image/png",  
              }   
            },
            {
              value: "Trailhead",
              symbol: {
                type: "picture-marker",
                url: "https://developers.arcgis.com/javascript/latest/sample-code/visualization-point-styles/live/Restaurant.png",
                contentType: "image/png",
              }
            },
            {
              value: "Ranger Station",
              symbol: {
                type: "picture-marker",
                url: "https://developers.arcgis.com/javascript/latest/sample-code/visualization-point-styles/live/Church.png",
                contentType: "image/png",
              }
            },
            {
              value: "Campground",
              symbol: {
                type: "picture-marker",
                url: "https://developers.arcgis.com/javascript/latest/sample-code/visualization-point-styles/live/Hotel.png",
                contentType: "image/png",
              }
            },
            {
              value: "Telephone",
              symbol: {
                type: "picture-marker",
                url: "https://developers.arcgis.com/javascript/latest/sample-code/visualization-point-styles/live/Park.png",
                contentType: "image/png",
              }
            },
          ]
        };
        
        // add the park points of interest featurelayer
        var layerPOI = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_poi/FeatureServer/0",
          outFields: ["POITYPE"],
          title: "Points of Interest",
          visible: true,
          renderer: layerPOIRenderer,
          popupTemplate: {
            // autocasts as new PopupTemplate()
            title: "{POINAME}: </br>{POITYPE}",
            overwriteActions: true
          }
        });
        
        
        
        // add the park fire history featurelayer
        var layerFireHistory = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_fhst/FeatureServer/0",
          //outFields: ["*"],
          opacity: 0.8,
          title: "Fire History",
          visible: false
        });
          
        // Create the Map
        const map = new Map({
          basemap: "topo-vector",
          layers: [layerBoundary, layerFireHistory, layerGroves, layerTrails, layerRoads, layerPOI]
        });
          
        let editor, features, editExpand, floodLayerView, queryLayerView;
          
          
         // *****************************************************
        // add homeButton and expand widgets to UI
        // *****************************************************
        function setupView() {
            
          // set home button view point to initial extent
          var homeButton = new Home({
            view: view
          });
          view.ui.add(homeButton, "top-left");
            
          var locateBtn = new Locate({
            view: view,
            goToOverride: function(view, options) {
                options.target.scale = 1500;
                return view.goTo(options.target);
          }
          });
            
          // Add the locate widget to the top left corner of the view
          view.ui.add(locateBtn, {
            position: "top-left"
          });
            
          //add text information
          view.ui.add("info", {
            position: "top-left",
            //index: 1
            });
        
        //add text information
          view.ui.add("infoToolbar", {
            position: "top-right",
            index: 2
            });
            
        }
          
          
          
        // *****************************************************
        // Creates actions in the LayerList
        // *****************************************************

        function defineActions(event) {
          // The event object contains an item property.
          // is is a ListItem referencing the associated layer
          // and other properties. You can control the visibility of the
          // item, its title, and actions using this object.

          const item = event.item;

          if (item.title === "SEKI Layers") {
            // An array of objects defining actions to place in the LayerList.
            // By making this array two-dimensional, you can separate similar
            // actions into separate groups with a breaking line.

            item.actionsSections = [
              [
                {
                  title: "Go to full extent",
                  className: "esri-icon-zoom-out-fixed",
                  id: "full-extent"
                },
                {
                  title: "Layer information",
                  className: "esri-icon-description",
                  id: "information"
                }
              ],
//              [
//                {
//                  title: "Increase opacity",
//                  className: "esri-icon-up",
//                  id: "increase-opacity"
//                },
//                {
//                  title: "Decrease opacity",
//                  className: "esri-icon-down",
//                  id: "decrease-opacity"
//                }
//              ]
            ];
          }
        }
          
          
        /*************************************************************
         * The PopupTemplate content is the text that appears inside the
         * popup. Bracketed {fieldName} can be used to reference the value
         * of an attribute of the selected feature. HTML elements can be
         * used to provide structure and styles within the content.
         **************************************************************/
        const editThisAction = {
          title: "Edit feature",
          id: "edit-this",
          className: "esri-icon-edit"
        };

        // Create a popupTemplate for the featurelayer and pass in a function to set its content and specify an action to handle editing the selected feature
        const template = {
          title: "User Name: {UserName}",
          content: OverallConLevel,
          fieldInfos: [
            {
              fieldName: "UserName"
            },
            {
              fieldName: "OverallCon"
            }
          ],
          actions: [editThisAction]
        };

        // Function that creates two popup elements for the template: attachments and text
        function OverallConLevel(feature) {
          // 1. Set how the attachments should display within the popup
          const attachmentsElement = new AttachmentsContent({
            displayType: "list"
          });

          const textElement = new TextContent();

//          const level = feature.graphic.attributes.OverallCon;
//          const green =
//            "<b><span style='color:green'>" + level + "</span></b>.";
//          const purple =
//            "<b><span style='color:purple'>" + level + "</span></b>.";
//          const red = "<b><span style='color:red'>" + level + "</span></b>.";

          // If the feature's "OverallCon" attribute is a specific value, set it a certain color
          // "easy" = green
          // "medium" = purple
          // "hard" = red
//          switch (level) {
//            case "easy":
//              textElement.text =
//                "The {UserName} trail has a OverallCon level of " + green;
//              return [textElement, attachmentsElement];
//              break;
//            case "medium":
//              textElement.text =
//                "The {UserName} trail has a OverallCon level of " + purple;
//              return [textElement, attachmentsElement];
//              break;
//            case "hard":
//              textElement.text =
//                "The {UserName} trail has a OverallCon level of " + red;
//              return [textElement, attachmentsElement];
//          }
        }

        var layerTrees = new FeatureLayer({
          url: "https://services.arcgis.com/HRPe58bUyBqyyiCt/arcgis/rest/services/seki_trees/FeatureServer/0",
          outFields: ["*"],
          title: "Sequoia Trees",
          visible: true,
//          popupTemplate: {
//            // autocasts as new PopupTemplate()
//            title: "{TRLNAME}: </br>{TRLCLASS}",
//            overwriteActions: true
//          }
          popupTemplate: template
        });
        map.add(layerTrees);

        // Create the MapView
        const view = new MapView({
          container: "viewDiv",
          map: map,
          zoom: 10,
          center: [-118.5, 36.65]
        });
          
        setupView();
          
        // *****************************************************
        // Create the LayerList widget with the associated actions
        // and add it to the top-right corner of the view.
        // *****************************************************
        
          // LayerList
          layerList = new LayerList({
              container: document.createElement("div"),
              view: view
            });
            
          let layerListExpand = new Expand({
              expandIconClass: "esri-icon-layers",
              expandTooltip: "Expand Layer List",
              view: view,
              expanded: false,
              content: layerList,
              group: "top-right"
            });
//            view.ui.add(layerListExpand, {
//                position: "bottom-left",
//                index: 1
//            });
          
        // *****************************************************
        // Create the Search widget with the associated actions
        // and add it to the top-right corner of the view.
        // *****************************************************
          
        var searchWidget = new Search({
          view: view,
          allPlaceholder: "Enter Location",
          includeDefaultSources: false,
          sources: [
            {
              layer: layerPOI,
              searchFields: ["POINAME"],
              displayField: "POINAME",
              exactMatch: false,
              outFields: ["POINAME", "POITYPE"],
              name: "Point of Interest",
              zoomScale: 10000,
              placeholder: "Example: Sherman Tree"
//              resultSymbol: {
//                type: "picture-marker", // autocasts as new PictureMarkerSymbol()
//                url: "https://developers.arcgis.com/javascript/latest/sample-code/widgets-search-multiplesource/live/images/senate.png",
//                height: 36,
//                width: 36
//              }
            },
            {
              layer: layerGroves,
              searchFields: ["Grove_Name"],
              //suggestionTemplate: "{Name}, Party: {Party}",
              exactMatch: false,
              outFields: ["Grove_Name"],
              placeholder: "Example: Atwell",
              name: "Sequoia Grove",

            },
            {
              layer: layerTrails,
              searchFields: ["TRLNAME"],
              //suggestionTemplate: "{Name}, Party: {Party}",
              exactMatch: false,
              outFields: ["TRLNAME", "TRLCLASS"],
              placeholder: "Example: Giant Forest",
              name: "SEKI Trails",

            },
          ]
        });
          
        //expand widget
          let searchExpand = new Expand({
            expandIconClass: "esri-icon-search",
            expandTooltip: "Expand Search",
            expanded: true,
            view: view,
            content: searchWidget,
            group: "top-right"
          });

        // Add the search widget to the top left corner of the view
        //view.ui.add(searchWidget, {position: "top-right"});
      
          
        // *****************************************************
        // Create the Editor widget with the associated actions
        // and add it to the top-right corner of the view.
        // *****************************************************

        view.when(() => {
          // Create the Editor with the specified layer and a list of field configurations
          var editor = new Editor({
            view: view,
            container: document.createElement("div"),
            layerInfos: [
              {
                layer: layerTrees,
                formTemplate: {
                  // autocasts to FormTemplate
                  elements: [
                    // autocasts to FieldElement
                    {
                      type: "field",
                      fieldName: "UserName",
                      label: "User name",
                      editable: true
                    },
                    {
                      type: "field",
                      fieldName: "UserType",
                      label: "User Type",
                      hint: "Select Role"
                    },
                    {
                      type: "field",
                      fieldName: "GroveName",
                      label: "Grove Name",
                      hint: "Where is the tree located?"
                    },
                    {
                      type: "field",
                      fieldName: "TreeDiam",
                      label: "Tree Diameter",
                      hint: "What is the trunk thickness?"
                    },
                    {
                      type: "field",
                      fieldName: "SurFuel",
                      label: "Surface Fuel",
                      hint: "How much built up fuel is there?"
                    },
                    {
                      type: "field",
                      fieldName: "BurnDamage",
                      label: "Burn Damage",
                      hint: "What is the burn damage on the tree?"
                    },
                    {
                      type: "field",
                      fieldName: "OverallCon",
                      label: "Overall Condition",
                      hint: "What is the overall condition?"
                    },
                    
                  ]
                }
              }
            ]
          });
            
        //expand widget
          editExpand = new Expand({
            expandIconClass: "esri-icon-edit",
            expandTooltip: "Expand Edit",
            expanded: true,
            view: view,
            content: editor,
            group: "top-right"
          });
            
          //view.ui.add(editExpand, "top-right");
          
            
        });
          
        // *****************************************************
        // Create the Query widget with the associated actions
        // and add it to the top-right corner of the view.
        // *****************************************************
        
        

        // additional query fields initially set to null for basic query
        let distance = 0.5;
        let units = "miles";

        //create graphic for mouse point click
        const pointGraphic = new Graphic({
          symbol: {
            type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
            color: [0, 0, 139],
            outline: {
              color: [255, 255, 255],
              width: 1.5
            }
          }
        });

        // Create graphic for distance buffer
        const bufferGraphic = new Graphic({
          symbol: {
            type: "simple-fill", // autocasts as new SimpleFillSymbol()
            color: [173, 216, 230, 0.2],
            outline: {
              // autocasts as new SimpleLineSymbol()
              color: [255, 255, 255],
              width: 1
            }
          }
        });

        // when query type changes, set appropriate values
        var queryOpts = document.getElementById("query-type");

        queryOpts.addEventListener("change", () => {
          switch (queryOpts.value) {
            // values set for distance query
            case "OneMile":
              distance = 1;
              units = "miles";
              break;
            case "TwoMiles":
              distance = 2;
              units = "miles";
              break;
            case "FiveMiles":
              distance = 5;
              units = "miles";
              break;
            default:
              // Default set to basic query
              distance = 0.5;
              units = "miles";
          }
        });
//        layerGroves.load().then(() => {
//          // Set the view extent to the data extent
//          //view.extent = layerGroves.fullExtent;
//          layerGroves.popupTemplate = layerGroves.createPopupTemplate();
//        });

        

        function queryFeatures(screenPoint) {
          const point = view.toMap(screenPoint);
          layerGroves.queryFeatures({
              geometry: point,
              // distance and units will be null if basic query selected
              distance: distance,
              units: units,
              spatialRelationship: "intersects",
              returnGeometry: false,
              returnQueryGeometry: true,
              outFields: ["*"]
            })
            .then((featureSet) => {
              // set graphic location to mouse pointer and add to mapview
              pointGraphic.geometry = point;
              view.graphics.add(pointGraphic);
              // open popup of query result
              view.popup.open({
                location: point,
                features: featureSet.features,
                featureMenuOpen: true
              });
              if (featureSet.queryGeometry) {
                bufferGraphic.geometry = featureSet.queryGeometry;
                view.graphics.add(bufferGraphic);
              }
            });
        }
          
        let queryExpand = new Expand({
            view: view,
            content: queryOpts,
            expandTooltip: "Expand Query",
            expandIconClass: "esri-icon-review",
            group: "top-right"
          });
          //start query tool when user clicks expand button
          
          queryExpand.watch("expanded", () => {
            if (queryExpand.expanded) {
                mouseEvtHandler = view.on("click", (event) => {
                    view.graphics.remove(pointGraphic);
                    if (view.graphics.includes(bufferGraphic)) {
                        view.graphics.remove(bufferGraphic);
                    }
                    queryFeatures(event);
                });
            }
            //clear the query when user closes the expand widget
            if (!queryExpand.expanded) {
                mouseEvtHandler.remove();
                mouseEvtHandler = null;
                view.graphics.remove(pointGraphic);
                    if (view.graphics.includes(bufferGraphic)) {
                        view.graphics.remove(bufferGraphic);
                    }
            }
          }); 
          
          //view.ui.add(queryExpand, "top-right");
          
        // *****************************************************
        // Create the Filter widget with the associated actions
        // and add it to the top-right corner of the view.
        // *****************************************************
          
        const poisNodes = document.querySelectorAll(`.poi-item`);
        const poisElement = document.getElementById("poi-filter");

        // click event handler for pois choices
        poisElement.addEventListener("click", filterBypoi);

        // User clicked on Winter, Spring, Summer or Fall
        // set an attribute filter on flood warnings layer view
        // to display the warnings issued in that poi
        function filterBypoi(event) {
          const selectedpoi = event.target.getAttribute("data-poi");
          floodLayerView.filter = {
            where: "POITYPE = '" + selectedpoi + "'"
          };
        }

        view.whenLayerView(layerPOI).then((layerView) => {
          // flash flood warnings layer loaded
          // get a reference to the flood warnings layerview
          floodLayerView = layerView;

          // set up UI items
          poisElement.style.visibility = "visible";
        
          let poisExpand = new Expand({
            view: view,
            content: poisElement,
            expandTooltip: "Expand Filter",
            expandIconClass: "esri-icon-filter",
            group: "top-right"
          });
          //clear the filters when user closes the expand widget
          poisExpand.watch("expanded", () => {
            if (!poisExpand.expanded) {
              floodLayerView.filter = null;
            }
          });
          //view.ui.add(poisExpand, "top-right");
          view.ui.add([searchExpand, editExpand, layerListExpand, poisExpand, queryExpand], "top-right");
        });
          
        
          
          
        
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="info" class="esri-widget">
      <h3>Select a feature to display its popup</h3>
      <h4>
        Edit by clicking on the "Edit feature" action within the
        popup.
      </h4>
    </div>
    <div id="infoToolbar" class="esri-widget">
        <h3>Sequoia and Kings Canyon Tree Locator</h3>
    </div>
    <div id="poi-filter" class="esri-widget">
      <div class="poi-item visible-poi" data-poi="Restroom">Restroom</div>
      <div class="poi-item visible-poi" data-poi="Ranger Station">Ranger HQ</div>
      <div class="poi-item visible-poi" data-poi="Trailhead">Trailhead</div>
      <div class="poi-item visible-poi" data-poi="Campground">Campground</div>
    </div>
    <div id="optionsDiv" class="esri-widget">
      <p>
        Select a query type and click a point on the map to view the results.
      </p>
      <select id="query-type" class="esri-widget">
        <option value="distance">1/2 Mile</option>
        <option value="OneMile">One Mile</option>
        <option value="TwoMiles">Two Miles</option>
        <option value="FiveMiles">Five Miles</option>
        
      </select>
    </div>
  </body>
</html>